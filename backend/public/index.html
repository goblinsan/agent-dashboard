<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI Agent Dashboard (MVP)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { font-family: system-ui, Arial, sans-serif; color-scheme: light dark; }
  body { margin: 0; padding: 0; background: #111; color: #e6e6e6; }
  header { padding: 1rem 1.25rem; background: #1d1d1d; display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; }
  h1 { font-size: 1.1rem; margin: 0 1rem 0 0; letter-spacing: .5px; }
  input[type=text] { padding: .4rem .6rem; border-radius: 4px; border: 1px solid #333; background:#181818; color:#fff; }
  button { padding: .45rem .9rem; border: 1px solid #444; background:#232323; color:#fff; border-radius:4px; cursor:pointer; }
  button:hover { background:#2d2d2d; }
  main { padding: 1rem; display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); }
  section { background:#1a1a1a; border:1px solid #2a2a2a; border-radius:6px; padding: .75rem .9rem 1rem; display:flex; flex-direction:column; min-height:220px; }
  form.create { display:flex; gap:.5rem; flex-wrap:wrap; margin:0 0 .6rem; }
  form.create input, form.create select { padding:.35rem .5rem; border-radius:4px; border:1px solid #333; background:#181818; color:#fff; }
  form.create button { flex:0 0 auto; }
  .hint { font-size:.55rem; opacity:.55; margin-top:.25rem; }
  section h2 { margin:.1rem 0 .75rem; font-size: .95rem; letter-spacing: .5px; font-weight:600; }
  ul { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:.4rem; }
  li { font-size:.8rem; line-height:1.1rem; padding:.35rem .5rem; background:#242424; border:1px solid #303030; border-radius:4px; display:flex; flex-direction:column; gap:2px; }
  .meta { opacity:.6; font-size:.65rem; }
  .status { font-weight:600; }
  .pill { display:inline-block; padding:2px 6px; border-radius:12px; font-size:.6rem; letter-spacing:.5px; background:#333; }
  .sev-high { background:#5d1f1f; }
  .sev-critical { background:#7d2020; }
  .sev-medium { background:#553d17; }
  .sev-low { background:#1f3d55; }
  #error { background:#5a1d1d; color:#ffb4b4; padding:.5rem .75rem; font-size:.75rem; display:none; }
  footer { padding: .75rem 1rem 2rem; font-size:.6rem; opacity:.55; }
  .loading { opacity:.55; font-style:italic; }
</style>
</head>
<body>
<header>
  <h1>Agent Dashboard (MVP)</h1>
  <label>API Key: <input id="apiKeyInput" type="text" size="42" placeholder="paste once" /></label>
  <button id="saveKeyBtn">Save</button>
  <button id="clearKeyBtn" title="Forget stored key">Clear</button>
  <span id="pollStatus" class="meta"></span>
</header>
<div id="error"></div>
<main>
  <section>
    <h2>Tasks <span id="tasksCount" class="meta"></span></h2>
    <form id="taskForm" class="create" autocomplete="off">
      <input type="text" id="taskTitle" placeholder="New task title" required minlength="3" />
      <select id="taskPriority">
        <option value="">priority</option>
        <option value="low">low</option>
        <option value="medium">medium</option>
        <option value="high">high</option>
        <option value="critical">critical</option>
      </select>
      <button type="submit">Add</button>
      <div class="hint" id="taskFormHint"></div>
    </form>
    <ul id="tasksList"><li class="loading">(waiting for data)</li></ul>
  </section>
  <section>
    <h2>Bugs <span id="bugsCount" class="meta"></span></h2>
    <ul id="bugsList"><li class="loading">(waiting for data)</li></ul>
  </section>
  <section>
    <h2>Status Updates <span id="updatesCount" class="meta"></span></h2>
    <form id="updateForm" class="create" autocomplete="off">
      <input type="text" id="updateMessage" placeholder="New status update" required minlength="3" size="28" />
      <button type="submit">Post</button>
      <div class="hint" id="updateFormHint"></div>
    </form>
    <ul id="updatesList"><li class="loading">(waiting for data)</li></ul>
  </section>
</main>
<footer>
  <div>Auto-refresh every 7s. Soft-deleted records hidden. Build for internal MVP validation only.</div>
</footer>
<script>
(function(){
  const KEY_STORAGE = 'agentDashboard.apiKey';
  const apiKeyInput = document.getElementById('apiKeyInput');
  const saveBtn = document.getElementById('saveKeyBtn');
  const clearBtn = document.getElementById('clearKeyBtn');
  const errorBox = document.getElementById('error');
  const pollMeta = document.getElementById('pollStatus');
  const tasksList = document.getElementById('tasksList');
  const taskForm = document.getElementById('taskForm');
  const taskTitle = document.getElementById('taskTitle');
  const taskPriority = document.getElementById('taskPriority');
  const taskFormHint = document.getElementById('taskFormHint');
  const bugsList = document.getElementById('bugsList');
  const updatesList = document.getElementById('updatesList');
  const updateForm = document.getElementById('updateForm');
  const updateMessage = document.getElementById('updateMessage');
  const updateFormHint = document.getElementById('updateFormHint');
  const tasksCount = document.getElementById('tasksCount');
  const bugsCount = document.getElementById('bugsCount');
  const updatesCount = document.getElementById('updatesCount');
  let pollTimer = null;
  let lastPollTs = 0;

  function loadApiKey(){
    const v = localStorage.getItem(KEY_STORAGE) || '';
    if (v) apiKeyInput.value = v;
    return v;
  }
  function storeApiKey(){
    localStorage.setItem(KEY_STORAGE, apiKeyInput.value.trim());
    startPolling();
  }
  function clearApiKey(){
    localStorage.removeItem(KEY_STORAGE); apiKeyInput.value=''; stopPolling();
    tasksList.innerHTML='<li class="loading">(no key)</li>';
    bugsList.innerHTML='<li class="loading">(no key)</li>';
    updatesList.innerHTML='<li class="loading">(no key)</li>';
  }
  saveBtn.addEventListener('click', storeApiKey);
  clearBtn.addEventListener('click', clearApiKey);

  async function api(path){
    const key = apiKeyInput.value.trim();
    if(!key) throw new Error('MISSING_KEY');
    const r = await fetch(path,{ headers:{ 'x-api-key': key }});
    const json = await r.json().catch(()=>({success:false,error:{code:'bad_json'}}));
    if(!r.ok || !json.success){
      const code = json?.error?.code || r.status;
      throw new Error(code);
    }
    return json.data;
  }
  async function apiPost(path, body){
    const key = apiKeyInput.value.trim();
    if(!key) throw new Error('MISSING_KEY');
    const r = await fetch(path,{ method:'POST', headers:{ 'x-api-key': key, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    const json = await r.json().catch(()=>({success:false,error:{code:'bad_json'}}));
    if(!r.ok || !json.success){
      const code = json?.error?.code || r.status;
      throw new Error(code);
    }
    return json.data;
  }

  function renderTasks(list){
    tasksCount.textContent = list.length? '('+list.length+')':'';
    tasksList.innerHTML = list.map(t=>{
      return `<li><div>${escapeHtml(t.title)}</div><div class="meta"><span class="status">${t.status}</span>${t.priority? ' 路 '+escapeHtml(t.priority):''} 路 v${t.version}</div></li>`;
    }).join('') || '<li class="loading">(none)</li>';
  }
  function renderBugs(list){
    bugsCount.textContent = list.length? '('+list.length+')':'';
    bugsList.innerHTML = list.map(b=>{
      const sevClass = 'sev-'+b.severity;
      return `<li><div>${escapeHtml(b.title)} <span class="pill ${sevClass}">${b.severity}</span></div><div class="meta">steps:${b.reproSteps.length}${b.proposedFix? ' 路 fix pending':''}</div></li>`;
    }).join('') || '<li class="loading">(none)</li>';
  }
  function renderUpdates(list){
    updatesCount.textContent = list.length? '('+list.length+')':'';
    updatesList.innerHTML = list.map(u=>{
      return `<li><div>${escapeHtml(u.message)}</div><div class="meta">${timeAgo(u.createdAt)} 路 ${u.actor}</div></li>`;
    }).join('') || '<li class="loading">(none)</li>';
  }

  async function poll(){
    const started = Date.now();
    try {
      errorBox.style.display='none';
      const [tasks, bugs, updates] = await Promise.all([
        api('/tasks'),
        api('/bugs'),
        api('/status-updates?limit=20')
      ]);
      renderTasks(tasks);
      renderBugs(bugs);
      renderUpdates(updates);
      lastPollTs = Date.now();
      pollMeta.textContent = 'Last update: '+new Date(lastPollTs).toLocaleTimeString();
    } catch (e){
      if(e.message==='MISSING_KEY'){ errorBox.textContent='API key required'; }
      else if(e.message==='invalid_api_key'){ errorBox.textContent='Invalid API key'; }
      else { errorBox.textContent='Error: '+e.message; }
      errorBox.style.display='block';
    } finally {
      const elapsed = Date.now()-started;
      // could log perf if needed
    }
  }

  function startPolling(){
    if(pollTimer) clearInterval(pollTimer);
    if(!apiKeyInput.value.trim()) return;
    poll();
    pollTimer = setInterval(poll, 7000);
  }
  function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer=null; }

  function timeAgo(ts){
    const diff = Date.now()-ts;
    const s = Math.floor(diff/1000); if(s<60) return s+'s ago';
    const m = Math.floor(s/60); if(m<60) return m+'m ago';
    const h = Math.floor(m/60); if(h<24) return h+'h ago';
    const d = Math.floor(h/24); return d+'d ago';
  }
  function escapeHtml(str){ return str.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }

  // Form handlers
  taskForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    taskFormHint.textContent='';
    const title = taskTitle.value.trim();
    if(title.length < 3){ taskFormHint.textContent='Title too short'; return; }
    const priority = taskPriority.value || undefined;
    taskTitle.disabled = taskPriority.disabled = true;
    try {
      await apiPost('/tasks', { title, priority });
      taskTitle.value=''; taskPriority.value='';
      taskFormHint.textContent='Created';
      poll(); // refresh immediately
    } catch(err){
      if(err.message==='MISSING_KEY'){ errorBox.textContent='API key required'; errorBox.style.display='block'; }
      else if(err.message==='title_required'){ taskFormHint.textContent='Title required'; }
      else if(err.message==='invalid_api_key'){ errorBox.textContent='Invalid API key'; errorBox.style.display='block'; }
      else { taskFormHint.textContent='Error: '+err.message; }
    } finally {
      taskTitle.disabled = taskPriority.disabled = false;
      setTimeout(()=>{ if(taskFormHint.textContent==='Created') taskFormHint.textContent=''; }, 1500);
    }
  });

  updateForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    updateFormHint.textContent='';
    const message = updateMessage.value.trim();
    if(message.length < 3){ updateFormHint.textContent='Too short'; return; }
    updateMessage.disabled = true;
    try {
      await apiPost('/status-updates', { message });
      updateMessage.value='';
      updateFormHint.textContent='Posted';
      poll();
    } catch(err){
      if(err.message==='MISSING_KEY'){ errorBox.textContent='API key required'; errorBox.style.display='block'; }
      else if(err.message==='validation_failed'){ updateFormHint.textContent='Validation failed'; }
      else if(err.message==='invalid_api_key'){ errorBox.textContent='Invalid API key'; errorBox.style.display='block'; }
      else { updateFormHint.textContent='Error: '+err.message; }
    } finally {
      updateMessage.disabled = false;
      setTimeout(()=>{ if(updateFormHint.textContent==='Posted') updateFormHint.textContent=''; }, 1500);
    }
  });

  // init
  loadApiKey();
  if(apiKeyInput.value) startPolling();
  apiKeyInput.addEventListener('keydown', e=>{ if(e.key==='Enter') { storeApiKey(); } });
})();
</script>
</body>
</html>
